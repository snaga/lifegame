# 設計書

## 機能一覧
- ライフゲームのシミュレーション機能
  - 世代交代ロジックの実行
  - ランダムな初期盤面の生成
- 画面表示機能
  - 盤面のセル状態の表示
  - 世代交代時の変更箇所のハイライト表示
  - 現在の世代数と処理ステータスの表示
- ユーザー操作機能
  - シミュレーションの一時停止と再開
  - アプリケーションの終了

## アーキテクチャ

- **モジュール構造**: `lifegame.py` は、`LifeGame`クラスを実装したモジュールとして構成する。`if __name__ == "__main__":` ブロックにより、直接実行も可能な構造とする。
- **状態管理**: ライフゲームの盤面状態は、メモリ効率を考慮し、1次元の`bytearray`で管理する。世代交代の計算を効率的に行うため、現在の盤面用と次世代の盤面用の2つの`bytearray`を保持する（ダブルバッファリング）。
- **描画**: `picocalc.display` ライブラリを利用して盤面を描画する。パフォーマンス向上のため、状態が変化したセルのみを描画する「差分描画」方式を採用する。
- **入力**: `picocalc.keyboard` ライブラリを利用して、ユーザーからのキー入力を非同期でポーリングする。
- **メインループ**: アプリケーションの中心となるループ処理で、以下のシーケンスを繰り返す。
  1. 現世代の白黒表示状態で3秒間待機。
  2. 次世代の状態を計算し、変更点をハイライト表示。
  3. ハイライト表示状態で1秒間待機。
  4. ハイライト表示を次世代の白黒表示に更新。

## コンポーネント

- **盤面 (Grid)**
  - 役割: ライフゲームのセルの状態を保持・管理する。
  - 実装: メモリ不足エラーを回避するため、1次元の`bytearray`を2つ（`grid`, `next_grid`）使用する。2次元座標 `(x, y)` へのアクセスは、インデックス `y * width + x` に変換して行う。
  - 世代交代: 現在の盤面(`grid`)から次世代の盤面(`next_grid`)を計算する。計算ロジックはパフォーマンス向上のため `@micropython.native` デコレータを付与する。計算後、2つの`bytearray`を交換する。

- **描画エンジン (Renderer)**
  - 役割: 盤面の状態を画面に表示する。
  - 実装: 以下の差分描画およびハイライト機能を持つメソッド群で構成する。
    - `draw_full_grid()`: アプリケーション開始時や一時停止からの復帰時に、盤面全体を描画する。
    - `_draw_changed_cells(use_highlight_colors)`: 描画ロジックの共通部分。前世代と現世代を比較し、状態が変化したセルのみを描画する。引数に応じて通常色かハイライト色かを切り替える。
    - `draw_highlights()`: 誕生・死亡セルをハイライト色で描画するために `_draw_changed_cells` を呼び出す。
    - `reset_highlights()`: ハイライト表示されたセルを本来の生存・死亡色に戻すために `_draw_changed_cells` を呼び出す。

- **入力ハンドラ (Input Handler)**
  - 役割: ユーザーのキー入力を検知し、アプリケーションの状態（実行中、一時停止中など）を制御する。
  - 実装: メインループ内で `keyboard.readinto()` を呼び出し、`P`キー（一時停止/再開）と`Q`キー（終了）を判定する。長い待機時間中もUIの応答性を維持するため、`time.sleep()`の前後でもキー入力をチェックする。

- **メインアプリケーション (Main App)**
  - 役割: 全体の初期化、メインループの実行、終了処理を行う。
  - 実装: `LifeGame`クラスの`run`メソッド内に実装する。`run`メソッド内には、画面下部のステータス行を更新するためのローカル関数 `update_status` を定義し、各処理のタイミングで呼び出す。一時停止中はCPU負荷低減のため、短い待機時間をループに入れる。

## インターフェース

### 画面
- **メイン領域**: 画面の大部分を占めるライフゲームの盤面表示領域。
- **ステータスバー**: 画面の最下部（40行目）に1行で表示されるテキスト領域。世代数、現在の処理ステータス、および操作方法のガイドを表示する。

### Web API
- Web APIは存在しない。

## データモデル

- **セル状態**:
  - `0`: 空 (Dead)
  - `1`: 生存 (Alive)
- **盤面データ構造**:
  - `grid = bytearray(width * height)`
  - 画面サイズとセルサイズの比率から、盤面の幅(`GRID_WIDTH`)と高さ(`GRID_HEIGHT`)を決定する。セル1つは `CELL_SIZE` (4x4) ピクセルで表現する。
- **シミュレーション状態**:
  - `generation`: 現在の世代数を保持する整数。`step`メソッドが呼ばれるたびにインクリメントされる。
- **色定義**:
  - `COLOR_DEAD`: 死亡セルの色（黒）
  - `COLOR_ALIVE`: 生存セルの色（白）
  - `COLOR_BORN`: 誕生セルをハイライトする色（緑/シアン）
  - `COLOR_DIED`: 死亡セルをハイライトする色（赤）

## エラーハンドリング

- 基本的にエラーが発生した場合はMicroPythonの例外に任せ、REPLにスタックトレースが出力される。アプリケーションとしての特別なエラーハンドリングは初期実装では行わない。